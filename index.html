<!DOCTYPE html>
<html>
<head>

    <title>Ramudroid</title>

    <meta charset="utf-8">
    <meta name="viewport" status="width=device-width, initial-scale=1, user-scalable=no">

    <!-- GOr web page Layout -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- Glovals varaibles -->
    <script type="text/javascript" src="property.js"></script>  

    <!-- Tensorflow and teachable machines -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

    <link rel=stylesheet href="css/webrtcpagestyle.css">

    <link rel=stylesheet href="css/ar.css">

    <!-- script that control motion and webservices -->
    <script src="scripts/rpiramudroid.js"></script>

    <!-- webrtc and opencv -->
    <script async src="webrtcscripts/cv.js"></script>
    <script src='webrtcscripts/objectdetection.js'></script>
    <script src='webrtcscripts/signalling.js'></script>
    <script src='webrtcscripts/main.js'></script>
    <script type='text/javascript'>
        var Module = {
            preRun: [],
            postRun: [],
            print: (function () {
                return function (text) {
                    text = Array.prototype.slice.call(arguments).join(' ');
                    console.log(text);
                };
            })(),
            printErr: function (text) {
                text = Array.prototype.slice.call(arguments).join(' ');
                console.error(text);
            }
        };
    </script>

</head>
<body>

<!-- top header -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#"> <img src="img/ramudroid_logo_white.png"/> </a>
        </div>
        <ul class="nav navbar-nav">
            <li><a href="#">Remote Navigation</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="resources.html">Resources</a></li>
            <li>
                <button class="btn btn-primary topButtons" onclick="callup()">Call up</button>
            </li>
            <li>
                <button class="btn btn-primary topButtons" onclick="motioncontrol()">Motion Control</button>
            </li>
            <li><a href="#">.</a></li>
        </ul>
    </div>
</nav>

<!-- camera streaming from Rpi -->
<div id="container">

    <div class="row">
        <div class="col-sm-9">
            <div>
                <input required type="text" id="address" value=""/>
                <button id='startwebrtcstream'>Start Streaming</button>
                <button id='stopwebrtcstream'>Stop Streaming</button>
            </div>
            <video id='videowebrtc'></video>
            <canvas id='canvaswebrtc'></canvas>

            <!-- Garbage Detection -->
            <div id="webcam-container"></div>
            <div id="label-container"></div>

            <button id='effect'>Toggle Object Detection</button>
        </div>
    </div>

    <div class="row controlBar">
        <table id="controls" class="panel-controlbuttons">
            <tr>
                <td></td>
                <td><input type="button" id="btn1" value="Forw" status="off" class="btn btn-success off"
                           onclick="togglebtn(this);clearotherbuttons('btn1');operation('forward');"/></td>
                <td></td>
            </tr>

            <tr>
                <td><input type="button" id="btn2" value="Left" status="off" class="btn btn-success off"
                           onclick="togglebtn(this);clearotherbuttons('btn2');operation('left');"/></td>

                <td><input type="button" id="btn3" value="Stop" status="off" class="btn btn-success off"
                           onclick="togglebtn(this);clearotherbuttons('btn3');operation('stop');"/></td>

                <td><input type="button" id="btn4" value="Right" status="off" class="btn btn-success off"
                           onclick="togglebtn(this);clearotherbuttons('btn4');operation('right');"/></td>
            </tr>

            <tr>
                <td></td>
                <td><input type="button" id="btn5" value="Back" status="off" class="btn btn-success off"
                           onclick="togglebtn(this);clearotherbuttons('btn5');operation('back');"/></td>
                <td></td>
            </tr>

            <tr style="height: 80;">
                <td>Clean : <input type="button" id="btn6" value="off" status="off" class="btn btn-success off_1"
                                   onclick="toggleState_1(this);operation('brushon');"/></td>

                <td>Pause : <input type="button" id="btn7" value="off" status="off" class="btn btn-success off_1"
                                   onclick="toggleState_1(this);operation('brushoff');"/></td>
                <td></td>
            </tr>
        </table>
    </div>
</div>

<div id="controls" class="mediaControlBar">
    <button id="pause" class="btn btn-default btn-mediaControlBar" onclick="pause();"
            title="pause or resume local player">Pause/Resume
    </button>
    <button id="mute" class="btn btn-default btn-mediaControlBar" onclick="mute();"
            title="mute or unmute remote audio source">Mute/Unmute
    </button>
    <button id="fullscreen" class="btn btn-default btn-mediaControlBar" onclick="fullscreen();">Fullscreen</button>
    <button type="button" class="btn btn-default btn-mediaControlBar" id="webrtcSettings">WebRTC Settings</button>
    <button type="button" class="btn btn-default btn-mediaControlBar" id="cpuSettings">Robot's CPU</button>
</div>

<a hidden target="_top" href="/">home</a>&nbsp;<a href="/panel" target="_blank"
                                                  title="change the image settings on-the-fly">control panel</a>

<!-- cpu modal -->
<div class="modal fade" id="cpuModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-status">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">RamuDroid Rpi CPU Info</h4>
            </div>
            <div class="modal-body">
                <div id="cpuinfoDiv" style="white-space: pre;">CPU info</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

</div>

</body>

<script>
    $(document).ready(function () {
        $("#webrtcSettings").click(function () {
            $("#webrtcModal").modal();
        });

        $("#cpuSettings").click(function () {

            $.ajax({
                async: false,
                url: 'cpuinfo',
                dataType: 'text',
                success: function (data) {
                    console.log(data);
                    document.getElementById("cpuinfoDiv").innerHTML = data;
                }
            });

            $("#cpuModal").modal();
        });

        $.ajax({
            url: "capturefile",
            dataType: "text",
            success: function (data) {
                $("#capturefile").html(data);
            }
        });

        // address of rpi_streaming_server
        document.getElementById('address').value = option.rpi_streaming_server+"/stream/webrtc";
    });

    function reload_js(src) {
        $('script[src="' + src + '"]').remove();
        $('<script>').attr('src', src).appendTo('head');
    }
</script>

<script src="scripts/requestanimationframedirection2.js"></script>

<script src="scripts/cpudata.js"></script>
<script>
 // the link to your model
 const URL = "./Model_Litter_Identification_classification/";

let model, webcam, labelContainer, maxPredictions;

// Load the image model and setup the webcam
async function init() {
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    // load the model and metadata
    // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
    // or files from your local hard drive
    // Note: the pose library adds "tmImage" object to your window (window.tmImage)
    model = await tmImage.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();

    labelContainer = document.getElementById("label-container");
        for (let i = 0; i < maxPredictions; i++) {
            labelContainer.appendChild(document.createElement("div"));
        }
}

        // Convenience function to setup a webcam
        const flip = true; // whether to flip the webcam
        webcam = new tmImage.Webcam(200, 200, flip); // width, height, flip
        await webcam.setup(); // request access to the webcam
        await webcam.play();
        window.requestAnimationFrame(loop);

        // append elements to the DOM
        document.getElementById("webcam-container").appendChild(webcam.canvas);


    // run the webcam image through the image model
    async function predict() {
        // predict can take in an image, video or canvas html element
        const prediction = await model.predict(webcam.canvas);
        for (let i = 0; i < maxPredictions; i++) {
            const classPrediction =
                prediction[i].className + ": " + prediction[i].probability.toFixed(2);
            labelContainer.childNodes[i].innerHTML = classPrediction;
        }
    }
</script>

</html>
